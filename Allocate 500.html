<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allocate</title>
  <style>
    :root{
      --bg1:#ff7aa2;
      --bg2:#ffb36a;
      --card:#ffffffcc;
      --card2:#ffffffb3;
      --ink:#1b1020;
      --muted:#5b4b61;
      --stroke:#ffffff66;
      --accent:#ff5f9a;
      --accent2:#ff9a5a;
      --shadow: 0 20px 55px rgba(25, 10, 30, .18);
      --shadow2: 0 10px 24px rgba(25, 10, 30, .12);
      --radius: 24px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.35), transparent 55%),
                  linear-gradient(145deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:22px 14px 40px;
    }

    .phone{
      width:min(420px, 100%);
      border-radius: 36px;
      padding: 16px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 6px 14px;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 6px 14px rgba(255,95,154,.35);
    }
    .pillbtn{
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.28);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:700;
      box-shadow: var(--shadow2);
      transition: transform .08s ease;
      user-select:none;
    }
    .pillbtn:active{ transform: translateY(1px) scale(.99); }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow2);
    }
    .stack{ display:flex; flex-direction:column; gap:12px; }

    .hero{
      text-align:center;
      padding: 18px 16px 14px;
    }
    .hero .label{
      font-weight:800;
      font-size:18px;
      margin: 0 0 6px 0;
    }
    .big{
      font-weight:900;
      font-size:64px;
      line-height:1;
      margin: 0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      letter-spacing: -1.5px;
    }

    .kpis{
      display:flex;
      gap:10px;
      margin-top: 14px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .kpi{
      background: rgba(255,255,255,.58);
      border: 1px solid rgba(255,255,255,.72);
      border-radius: 18px;
      padding: 10px 12px;
      min-width: 155px;
      text-align:left;
    }
    .kpi .klabel{ font-size:12px; color:var(--muted); font-weight:700; }
    .kpi .kval{ font-size:18px; font-weight:900; margin-top: 2px; }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin: 0 0 6px 2px;
    }
    input{
      width:100%;
      border:1px solid rgba(255,255,255,.8);
      background: rgba(255,255,255,.8);
      border-radius: 16px;
      padding: 12px 12px;
      font-size: 16px;
      font-weight:800;
      outline:none;
    }
    input:focus{
      border-color: rgba(255,95,154,.55);
      box-shadow: 0 0 0 4px rgba(255,95,154,.18);
    }

    .field{ flex: 1 1 170px; }
    .field.small{ flex: 1 1 140px; }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.6);
      border: 1px solid rgba(255,255,255,.75);
      min-height: 50px;
      flex: 1 1 190px;
    }
    .toggle input{
      width: 20px;
      height: 20px;
      margin:0;
      accent-color: var(--accent);
      box-shadow:none;
    }
    .toggle span{
      font-weight:900;
      font-size:16px;
    }

    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      border-radius: 18px;
      padding: 14px 14px;
      font-weight:900;
      font-size: 18px;
      color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 30px rgba(255,95,154,.30);
      transition: transform .08s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn.ghost{
      background: rgba(255,255,255,.35);
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.65);
      box-shadow: var(--shadow2);
    }

    .tabs{
      display:flex;
      gap:10px;
      padding: 12px 6px 0;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 12px 12px;
      border-radius: 18px;
      font-weight:900;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.22);
      user-select:none;
    }
    .tab.active{
      background: rgba(255,255,255,.62);
    }

    .section{ display:none; margin-top:12px; }
    .section.active{ display:block; }

    .mini{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 6px;
    }
    .mini .hint{
      font-size:12px;
      color: var(--muted);
      font-weight:700;
    }

    .log{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 18px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.72);
    }
    .log th, .log td{
      text-align:left;
      padding: 10px 10px;
      font-size: 13px;
      border-bottom: 1px solid rgba(255,255,255,.55);
      vertical-align: top;
    }
    .log th{
      font-size: 12px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      background: rgba(255,255,255,.45);
    }
    .log tr:last-child td{ border-bottom:0; }
    .right{ text-align:right; }
    .del{
      border: 1px solid rgba(255,255,255,.7);
      background: rgba(255,255,255,.55);
      color: var(--ink);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .del:active{ transform: translateY(1px) scale(.99); }

    .sunday{
      display:none;
    }
    .sunday.show{ display:block; }

    .spacer{ height: 8px; }
  </style>
</head>
<body>
  <div class="phone">
    <div class="topbar">
      <div class="brand"><span class="dot"></span>Allocate</div>
      <button class="pillbtn" id="exportBtn">Export</button>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="dash">Dashboard</div>
      <div class="tab" data-tab="log">Log</div>
    </div>

    <div class="section active" id="dash">
      <div class="stack">
        <div class="card hero">
          <div class="label">Calories left today</div>
          <p class="big" id="leftBig">0</p>

          <div class="kpis">
            <div class="kpi">
              <div class="klabel">Burned yesterday</div>
              <div class="kval" id="yTdeeKpi">0</div>
            </div>
            <div class="kpi">
              <div class="klabel">Allocated today</div>
              <div class="kval" id="budgetKpi">0</div>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="row">
            <div class="field">
              <label for="tdeeInput">Yesterday's TDEE</label>
              <input id="tdeeInput" type="number" inputmode="numeric" min="0" />
            </div>

            <div class="toggle" title="Maintenance day">
              <input id="maintenanceToggle" type="checkbox" />
              <span>Maintenance day</span>
            </div>
          </div>

          <div class="spacer"></div>
          <button class="btn" id="applyBtn">Apply</button>

          <div class="mini">
            <div class="hint" id="modeHint"></div>
            <div class="hint" id="savedHint"></div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div class="field">
              <label for="addInput">Add calories</label>
              <input id="addInput" type="number" inputmode="numeric" min="0" />
            </div>
            <div class="field small">
              <button class="btn" id="addBtn">Add</button>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="kpis" style="justify-content:space-between">
            <div class="kpi" style="min-width: 48%;">
              <div class="klabel">Today's running intake</div>
              <div class="kval" id="intakeKpi">0</div>
            </div>
            <div class="kpi" style="min-width: 48%;">
              <div class="klabel">Remaining</div>
              <div class="kval" id="remainKpi">0</div>
            </div>
          </div>

          <div class="spacer"></div>
          <button class="btn" id="endDayBtn">End day</button>
        </div>

        <div class="card sunday" id="weighCard">
          <div class="row">
            <div class="field">
              <label for="weightInput">Weekly weigh-in</label>
              <input id="weightInput" type="number" inputmode="decimal" step="0.1" min="0" />
            </div>
            <div class="field small">
              <button class="btn ghost" id="saveWeightBtn">Save</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="section" id="log">
      <div class="stack">
        <div class="card">
          <table class="log" id="logTable">
            <thead>
              <tr>
                <th>Date</th>
                <th class="right">TDEE</th>
                <th class="right">Budget</th>
                <th class="right">Intake</th>
                <th class="right">Left</th>
                <th>Mode</th>
                <th class="right">Weight</th>
                <th class="right"></th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    const DEFICIT = 500;
    const LS_STATE = "allocate_today_state_v2";
    const LS_LOG = "allocate_log_v2";
    const LS_WEIGHTS = "allocate_weights_v2";

    const el = (id) => document.getElementById(id);

    const fmt = (n) => {
      const x = Number.isFinite(n) ? Math.round(n) : 0;
      return x.toLocaleString("en-GB");
    };

    const todayISO = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    };

    const isSunday = () => new Date().getDay() === 0;

    const isoWeekKey = (date = new Date()) => {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      const year = d.getUTCFullYear();
      return `${year}-W${String(weekNo).padStart(2, "0")}`;
    };

    const loadJSON = (key, fallback) => {
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch{
        return fallback;
      }
    };

    const saveJSON = (key, value) => {
      localStorage.setItem(key, JSON.stringify(value));
    };

    const defaultState = () => ({
      date: todayISO(),
      yTdee: 0,
      maintenance: false,
      budget: 0,
      intake: 0
    });

    let state = loadJSON(LS_STATE, null);
    if(!state || !state.date){
      state = defaultState();
      saveJSON(LS_STATE, state);
    }
    if(state.date !== todayISO()){
      state = defaultState();
      saveJSON(LS_STATE, state);
    }

    const getLog = () => loadJSON(LS_LOG, []);
    const setLog = (arr) => saveJSON(LS_LOG, arr);

    const getWeights = () => loadJSON(LS_WEIGHTS, {});
    const setWeights = (obj) => saveJSON(LS_WEIGHTS, obj);

    const calcBudget = () => {
      const t = Math.max(0, Number(state.yTdee || 0));
      if(state.maintenance) return t;
      return Math.max(0, t - DEFICIT);
    };

    const calcLeft = () => Math.round(calcBudget() - Number(state.intake || 0));

    const render = () => {
      state.budget = calcBudget();

      el("tdeeInput").value = state.yTdee ? String(state.yTdee) : "";
      el("maintenanceToggle").checked = !!state.maintenance;

      el("yTdeeKpi").textContent = fmt(state.yTdee || 0);
      el("budgetKpi").textContent = fmt(state.budget || 0);

      const left = calcLeft();
      el("leftBig").textContent = fmt(left);
      el("intakeKpi").textContent = fmt(state.intake || 0);
      el("remainKpi").textContent = fmt(left);

      el("modeHint").textContent = state.maintenance ? "Maintenance day" : "Deficit day";
      el("savedHint").textContent = "Saved";

      saveJSON(LS_STATE, state);

      renderLog();
      renderSundayWeighIn();
    };

    const renderLog = () => {
      const log = getLog().slice().sort((a,b) => (a.date < b.date ? 1 : -1));
      const weights = getWeights();

      const body = el("logBody");
      body.innerHTML = "";

      for(const entry of log){
        const tr = document.createElement("tr");

        const left = Math.round((entry.budget || 0) - (entry.intake || 0));
        const w = (weights && weights[entry.weekKey]) ? weights[entry.weekKey] : "";

        tr.innerHTML = `
          <td>${entry.date || ""}</td>
          <td class="right">${fmt(entry.yTdee || 0)}</td>
          <td class="right">${fmt(entry.budget || 0)}</td>
          <td class="right">${fmt(entry.intake || 0)}</td>
          <td class="right">${fmt(left)}</td>
          <td>${entry.maintenance ? "Maintenance" : "Deficit"}</td>
          <td class="right">${w !== "" ? String(w) : ""}</td>
          <td class="right"><button class="del" data-del="${entry.id}">Delete</button></td>
        `;

        body.appendChild(tr);
      }

      body.querySelectorAll("[data-del]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del");
          const next = getLog().filter(x => String(x.id) !== String(id));
          setLog(next);
          renderLog();
        });
      });
    };

    const renderSundayWeighIn = () => {
      const card = el("weighCard");
      if(!isSunday()){
        card.classList.remove("show");
        return;
      }
      const key = isoWeekKey(new Date());
      const weights = getWeights();
      const has = Object.prototype.hasOwnProperty.call(weights, key);

      card.classList.add("show");
      el("weightInput").value = has ? String(weights[key]) : "";
      el("saveWeightBtn").disabled = has;
      el("saveWeightBtn").textContent = has ? "Saved" : "Save";
    };

    el("applyBtn").addEventListener("click", () => {
      const v = Number(el("tdeeInput").value || 0);
      state.yTdee = Number.isFinite(v) ? Math.round(v) : 0;
      state.maintenance = !!el("maintenanceToggle").checked;
      render();
    });

    el("maintenanceToggle").addEventListener("change", () => {
      state.maintenance = !!el("maintenanceToggle").checked;
      render();
    });

    el("addBtn").addEventListener("click", () => {
      const v = Number(el("addInput").value || 0);
      if(!Number.isFinite(v) || v <= 0) return;
      state.intake = Math.max(0, Math.round(Number(state.intake || 0) + v));
      el("addInput").value = "";
      render();
    });

    el("addInput").addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        el("addBtn").click();
      }
    });

    el("endDayBtn").addEventListener("click", () => {
      state.budget = calcBudget();

      const entry = {
        id: `${state.date}_${Date.now()}`,
        date: state.date,
        yTdee: Math.round(state.yTdee || 0),
        maintenance: !!state.maintenance,
        budget: Math.round(state.budget || 0),
        intake: Math.round(state.intake || 0),
        weekKey: isoWeekKey(new Date())
      };

      const log = getLog();
      const existingIdx = log.findIndex(x => x.date === entry.date);
      if(existingIdx >= 0){
        log[existingIdx] = entry;
      }else{
        log.push(entry);
      }
      setLog(log);

      state = defaultState();
      saveJSON(LS_STATE, state);
      render();
    });

    el("saveWeightBtn").addEventListener("click", () => {
      if(!isSunday()) return;

      const key = isoWeekKey(new Date());
      const weights = getWeights();
      if(Object.prototype.hasOwnProperty.call(weights, key)) return;

      const v = Number(el("weightInput").value || 0);
      if(!Number.isFinite(v) || v <= 0) return;

      weights[key] = v;
      setWeights(weights);
      renderSundayWeighIn();
      renderLog();
    });

    el("exportBtn").addEventListener("click", () => {
      const payload = {
        exportedAt: new Date().toISOString(),
        deficit: DEFICIT,
        log: getLog(),
        weights: getWeights()
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `allocate_export_${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    document.querySelectorAll(".tab").forEach((t) => {
      t.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        t.classList.add("active");

        const name = t.getAttribute("data-tab");
        el("dash").classList.toggle("active", name === "dash");
        el("log").classList.toggle("active", name === "log");
      });
    });

    render();

    // FYI: This app saves to localStorage.
    // If you clear site data for this file, the log disappears, so export when you want a backup.
  </script>
</body>
</html>
